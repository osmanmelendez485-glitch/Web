<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resumen Acumulado por Propiedad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f7f6; }
        .card-resumen { border: none; border-radius: 12px; transition: transform 0.2s; }
        @media print { .no-print { display: none !important; } body { background: white; } }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <a href="/dashboard" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Panel Principal</a>
            <button onclick="window.print()" class="btn btn-dark"><i class="bi bi-printer"></i> Imprimir Reporte</button>
        </div>

        <div class="card card-resumen shadow-sm mb-4 no-print">
            <div class="card-body">
                <form method="POST" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Fecha Desde</label>
                        <input type="date" name="desde" class="form-control form-control-sm" value="{{ desde }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Fecha Hasta</label>
                        <input type="date" name="hasta" class="form-control form-control-sm" value="{{ hasta }}">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Propiedad / Dirección</label>
                        <select name="direccion" class="form-select form-select-sm">
                            <option value="">Todas las propiedades</option>
                            {% set opciones = ["Miguel Jarquín", "Chinandega", "Invercasa SAFI", "Modulo 1", "Modulo 2"] %}
                            {% for opcion in opciones %}
                                <option value="{{ opcion }}" {% if direccion_sel == opcion %}selected{% endif %}>
                                    {{ opcion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-filter"></i> Generar Resumen</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="text-center mb-4">
            <h3 class="fw-bold">Resumen Acumulado de Propiedades</h3>
            <p class="text-muted">
                Periodo: {{ desde }} al {{ hasta }}
                {% if direccion_sel %} | <strong>Filtrado por: {{ direccion_sel }}</strong>{% endif %}
            </p>
        </div>

        <div class="table-responsive bg-white p-3 rounded shadow-sm">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Propiedad / Dirección</th>
                        <th>Inquilino Actual</th>
                        <th class="text-end">Total Periodo</th>
                        <th class="text-end text-success">Recaudado</th>
                        <th class="text-end text-danger">Pendiente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in resumen %}
                    <tr>
                        <td><i class="bi bi-house-door text-primary me-2"></i><strong>{{ r.direccion }}</strong></td>
                        <td>{{ r.inquilino }}</td>
                        <td class="text-end fw-bold">C$ {{ "{:,.2f}".format(r.total) }}</td>
                        <td class="text-end text-success">C$ {{ "{:,.2f}".format(r.recaudado) }}</td>
                        <td class="text-end text-danger">C$ {{ "{:,.2f}".format(r.pendiente) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">No se encontraron movimientos para el filtro seleccionado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if resumen %}
                <tfoot class="table-secondary">
                    {% set total_general = resumen | map(attribute='total') | sum %}
                    {% set total_recaudado = resumen | map(attribute='recaudado') | sum %}
                    {% set total_pendiente = resumen | map(attribute='pendiente') | sum %}
                    <tr class="fw-bold">
                        <td colspan="2">TOTALES GENERALES</td>
                        <td class="text-end text-primary">C$ {{ "{:,.2f}".format(total_general) }}</td>
                        <td class="text-end text-success">C$ {{ "{:,.2f}".format(total_recaudado) }}</td>
                        <td class="text-end text-danger">C$ {{ "{:,.2f}".format(total_pendiente) }}</td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</body>
</html>